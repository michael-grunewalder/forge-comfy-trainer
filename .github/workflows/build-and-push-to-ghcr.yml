name: Build and push Docker image to GHCR

on:
push:
branches:
- main
workflow_dispatch: {} # allows manual run from Actions tab

jobs:
build-and-push:
runs-on: ubuntu-latest
permissions:
contents: read
packages: write

steps:
  - name: 📦 Checkout repository
    uses: actions/checkout@v4

  # -----------------------------------------------------------------
  # 💥 CRITICAL STEP 1: MAXIMIZE FREE DISK SPACE 💥
  # FIX: Changed deprecated individual flags (remove-dotnet: 'true') 
  # to the single 'removing' argument, as per the action's best practice.
  - name: Maximize build space
    uses: easimon/maximize-build-space@master
    with:
      # Safe reserve value confirmed from 'maximize_build_step.md'
      root-reserve-mb: '5000' 
      temp-reserve-mb: '100'
      swap-size-mb: '4096'
      # Use the stable 'removing' input with space-separated items
      removing: 'dotnet android haskell codeql'
  # -----------------------------------------------------------------

  - name: 🏗️ Set up QEMU (for multi-arch builds, optional)
    uses: docker/setup-qemu-action@v3

  - name: 🛠️ Set up Docker Buildx
    uses: docker/setup-buildx-action@v3

  - name: 🔑 Login to GHCR
    uses: docker/login-action@v2
    with:
      registry: ghcr.io
      username: ${{ github.actor }}
      password: ${{ secrets.GHCR_PAT }}

  - name: 🐳 Build and Push Image (with GHA Caching)
    uses: docker/build-push-action@v5
    with:
      context: .
      file: ./Dockerfile
      push: true
      tags: ghcr.io/michael-grunewalder/bearnys-ai-lab:latest
      platforms: linux/amd64
      # -----------------------------------------------------------------
      # ⚡ CRITICAL STEP 2: ENABLE CACHING
      # cache-from: Load previous layers, preventing re-download of the 9.8GB base image.
      # cache-to: Save new layers for the next build.
      cache-from: type=gha
      cache-to: type=gha,mode=max 
      # -----------------------------------------------------------------

  - name: ✅ Verify pushed image
    run: |
      echo "Image pushed: ghcr.io/michael-grunewalder/bearnys-ai-lab:latest"